var geoApp=angular.module("starter",["ionic","starter.controllers","ngCordova","pascalprecht.translate"]).run(["$ionicPlatform","$rootScope","SettingsService",function(t,e,a){t.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),e.loadScript=function(t,e,a){if(void 0===e&&(e="text/javascript"),t){var n=document.querySelector("script[src*='"+t+"']");if(!n){var r=document.getElementsByTagName("head");if(r&&r.length){var o=r[0];o&&(n=document.createElement("script"),n.setAttribute("src",t),n.setAttribute("type",e),a&&n.setAttribute("charset",a),o.appendChild(n))}}return n}},e.$watch("apikey",function(t){e.loadScript("https://maps.googleapis.com/maps/api/js?key="+t)}),e.apikey=a.get().apikey})}]).config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("app",{url:"/app",abstract:!0,templateUrl:"templates/menu.html",controller:"AppCtrl"}).state("app.track",{url:"/track",cache:!1,views:{menuContent:{templateUrl:"templates/track.html",controller:"TrackController"}}}).state("app.history",{url:"/history",cache:!1,views:{menuContent:{templateUrl:"templates/history.html",controller:"HistoryController"}}}).state("app.trackview",{url:"/track/:trackId",cache:!1,views:{menuContent:{templateUrl:"templates/track-view.html",controller:"TrackViewController"}}}).state("app.trackedit",{url:"/track/edit/:trackId",cache:!1,views:{menuContent:{templateUrl:"templates/track-edit.html",controller:"TrackEditController"}}}).state("app.settings",{url:"/settings",cache:!1,views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsController"}}}),e.otherwise("/app/track")}]).config(["$translateProvider",function(t){t.translations("en",TRANSLATIONS.en),t.translations("bg",TRANSLATIONS.bg),t.useSanitizeValueStrategy("escape");var e=JSON.parse(localStorage.getItem("locale")),a=_.isNull(e)?"bg":e.id;t.preferredLanguage(a)}]),ctrl=angular.module("starter.controllers",[]),TRANSLATIONS={en:{name:"English","nav.menu":"Menu","nav.home":"Home","nav.history":"History","nav.settings":"Settings","nav.edit":"Edit","track.start":"Start new track","track.stop":"Stop","track.save":"Save","track.title":"Track title","track.notes":"Track notes","track.point_no":"Point #{{ id }}","track.longitude":"Longitude","track.latitude":"Latitude","track.altitude":"Altitude","track.direction":"Heading","track.speed":"Speed","track.details":"Details","track.delete":"Delete","track.edit":"Edit","track.startTime":"Start","track.endTime":"End","track.duration":"Duration","settings.language":"Language","settings.apikey":"Google API Key","dialog.confirm":"Confirm","dialog.track.confirm":"Are you sure you want to delete this track?","common.yes":"Yes","common.no":"No","common.cancel":"Cancel","time.year":"year(s)","time.month":"month(s)","time.day":"day(s)","time.hour":"hour(s)","time.minute":"minute(s)","time.second":"second(s)"},bg:{name:"Български","nav.menu":"Меню","nav.home":"Начало","nav.history":"История","nav.settings":"Настройки","nav.edit":"Редактирай","track.startTime":"Начало","track.endTime":"Край","track.duration":"Време","track.start":"Нов маршрут","track.stop":"Стоп","track.save":"Запази","track.title":"Име на маршрута","track.notes":"Бележки","track.point_no":"Точка №{{ id }}","track.longitude":"Геогр. дълж.","track.latitude":"Геогр. шир.","track.altitude":"Надм. вис.","track.direction":"Посока","track.speed":"Скорост","track.details":"Детайли","track.delete":"Изтрий","track.edit":"Редактирай","settings.language":"Език","settings.apikey":"Google API Key","dialog.confirm":"Потвърди","dialog.track.confirm":"Наистина ли искате да изтриете този запис?","common.yes":"Да","common.no":"Не","common.cancel":"Откажи","time.year":"г.","time.month":"мес.","time.day":"дн.","time.hour":"ч.","time.minute":"мин.","time.second":"сек."}};ctrl.controller("AppCtrl",function(){}),ctrl.controller("SettingsController",["$rootScope","$scope","$translate","$timeout","I18nService","SettingsService",function(t,e,a,n,r,o){e.availableLanguages=r.getAvailableLanguages(),e.settings=o.get(),e.selectedLanguage=JSON.parse(localStorage.getItem("locale")),e.setPreferedLanguage=function(t){r.setPreferedLanguage(t)},e.saveSettings=function(){o.set(e.settings),e.settings=o.get(),t.apikey=e.settings.apikey}}]),geoApp.service("I18nService",["$translate",function(t){this.getAvailableLanguages=function(){var t=[];return angular.forEach(TRANSLATIONS,function(e,a){t.push({id:a,name:e.name})}),t},this.setPreferedLanguage=function(e){localStorage.setItem("locale",JSON.stringify(e)),t.use(e.id)}}]),geoApp.service("SettingsService",["$translate",function(t){var e={apikey:"AIzaSyD8JvJ-krHO-x3ZU6It0rf_wOM2hK3KY4k"};this.get=function(){return _.defaults(JSON.parse(localStorage.getItem("settings")),e)},this.set=function(t){var t=_.omitBy(t,function(t){return _.isEmpty(t)});t=_.defaults(t,e),localStorage.setItem("settings",JSON.stringify(t))}}]),geoApp.factory("TrackStorage",["$translate",function(t){var e="tracks",a={};a.getAll=function(){var t=r();return _.isNull(t)?[]:JSON.parse(t)},a.getById=function(t){return _.find(a.getAll(),{trackId:parseInt(t)})},a.save=function(t){var e=a.getAll(),r={trackId:t.trackId},o=!!_.find(e,r);if(_.isEmpty(e))e.push(t);else if(_.isEmpty(e)||o){if(!_.isEmpty(e)&&o){var i=_.findIndex(e,r);e[i]=t}}else e.push(t);n(e)},a.delete=function(t){var e=a.getAll();_.remove(e,function(e){return e.trackId===t.trackId}),n(e)},a.formatDuration=function(e){return moment.duration(e,"seconds").format("Y ["+t.instant("time.year")+"], M ["+t.instant("time.month")+"], D ["+t.instant("time.day")+"], h ["+t.instant("time.hour")+"], m ["+t.instant("time.minute")+"], s ["+t.instant("time.second")+"]")};var n=function(t){localStorage.setItem(e,JSON.stringify(t))},r=function(){return localStorage.getItem(e)};return a}]),ctrl.controller("TrackEditController",["$scope","$state","$stateParams","TrackStorage",function(t,e,a,n){t.track=n.getById(a.trackId),t.updateTrack=function(){n.save(t.track),e.go("app.trackview",a)}}]),ctrl.controller("HistoryController",["$scope","TrackStorage",function(t,e){t.items=e.getAll()}]),ctrl.controller("TrackController",["$scope","$state","$ionicLoading","$cordovaGeolocation","$translate","TrackStorage",function(t,e,a,n,r,o){t.isTracking=!1,t.readyToSave=!1,t.startTracking=function(){t.startTime=new Date,a.show(),n.getCurrentPosition({timeout:1e4,enableHighAccuracy:!0,maximumAge:3e3}).then(function(e){t.$broadcast("tracking:started"),t.positionSuccess(e)},t.positionError).finally(function(){a.hide()})},t.positionSuccess=function(e){t.points.push(e),t.trackWatch||t.watchTracking(),t.updateMap(e.coords.latitude,e.coords.longitude)},t.positionError=function(t){console.log("error",t)},t.watchTracking=function(){t.trackWatch=n.watchPosition({timeout:3e3,enableHighAccuracy:!1}),t.trackWatch.then(null,t.positionError,t.positionSuccess)},t.initMap=function(){if(_.isUndefined(t.map)){var e={zoom:1,mapTypeId:google.maps.MapTypeId.ROADMAP};t.map=new google.maps.Map(document.getElementById("map"),e)}},t.updateMap=function(e,a){angular.isUndefined(t.map)&&t.initMap();var n=new google.maps.LatLng(e,a),r=new google.maps.Marker({position:n});r.setMap(t.map),t.map.setZoom(15),t.map.setCenter(r.getPosition())},t.resetMap=function(){var e=document.getElementById("map");e.innerHTML="",e.removeAttribute("style"),t.map=null},t.stopTracking=function(){t.endTime=new Date,t.isTracking=!1,t.trackWatch.clearWatch(),t.$broadcast("tracking:stopped")},t.saveHistory=function(){var e={trackId:t.trackId,points:t.points,info:_.omitBy(t.trackInfo,function(t){return _.isEmpty(t)}),startTime:t.startTime,endTime:t.endTime,duration:moment(t.endTime).diff(moment(t.startTime),"seconds")};o.save(e),t.$broadcast("tracking:saved")},t.$on("tracking:started",function(e,a){t.initMap(),t.isTracking=!0,t.points=[],t.trackWatch=null,t.trackId=(new Date).getTime(),t.trackInfo={title:null,notes:null}}),t.$on("tracking:stopped",function(e,a){t.readyToSave=!0}),t.$on("tracking:saved",function(a,n){t.resetMap(),t.points=[],t.readyToSave=!1,e.go("app.history")})}]),ctrl.controller("TrackViewController",["$scope","$state","$stateParams","$ionicPopup","$translate","TrackStorage",function(t,e,a,n,r,o){t.track=o.getById(a.trackId),t.formattedDuration=o.formatDuration(t.track.duration),t.confirmDelete=function(){var e=n.confirm({title:r.instant("dialog.confirm"),template:r.instant("dialog.track.confirm"),cancelText:r.instant("common.cancel"),cancelType:"button-positive",okText:r.instant("common.yes"),okType:"button-default"});e.then(function(e){e&&t.deleteTrack()})},t.deleteTrack=function(){o.delete(t.track),e.go("app.history")}}]);