var geoApp=angular.module("toxic.geotracker",["ionic","toxic.geotracker.controllers","ngCordova","pascalprecht.translate","nvd3"]).run(["$ionicPlatform","$rootScope","$timeout","$translate","SettingsService",function(t,e,n,a,o){t.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),e.apikey=o.get().apikey,e.$on("locale-changed",function(t,e){a.use(e.id)});var t=window.matchMedia("(orientation: portrait)");t.matches,t.addListener(function(t){n(t.matches?function(){angular.element(document.getElementById("map")).css("height","initial"),google.maps.event.trigger(e.map,"resize")}:function(){angular.element(document.getElementById("map")).css("height",screen.height*e.mapScreenScale+"px"),google.maps.event.trigger(e.map,"resize")})})})}]).provider("settingsService",function(){return this.$get=function(){return new SettingsService},this}).config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("app",{url:"/app",abstract:!0,templateUrl:"templates/menu.html",controller:"AppCtrl"}).state("app.track",{url:"/track",cache:!1,resolve:{requiredMapType:["SettingsService",function(t){return t.get().mapType.id}]},views:{menuContent:{templateUrl:"templates/track.html",controller:"TrackController"}}}).state("app.history",{url:"/history",cache:!1,views:{menuContent:{templateUrl:"templates/history.html",controller:"HistoryController"}}}).state("app.trackview",{url:"/track/:trackId",cache:!1,resolve:{track:["$stateParams","TrackStorage",function(t,e){return e.getById(t.trackId)}],requiredMapType:["SettingsService",function(t){return t.get().mapType.id}]},views:{menuContent:{templateUrl:"templates/track-view.html",controller:"TrackViewController"}}}).state("app.trackedit",{url:"/track/edit/:trackId",cache:!1,views:{menuContent:{templateUrl:"templates/track-edit.html",controller:"TrackEditController"}}}).state("app.settings",{url:"/settings",cache:!1,resolve:{mapTypes:["SettingsService",function(t){return t.getMapTypes()}],availableLanguages:["I18nService",function(t){return t.getAvailableLanguages()}],settings:["SettingsService",function(t){return t.get()}]},views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsController"}}}).state("app.about",{url:"/about",cache:!1,views:{menuContent:{templateUrl:"templates/about.html",controller:"AboutController"}}}),e.otherwise("/app/track")}]).config(["$translateProvider",function(t){t.translations("en",TRANSLATIONS.en),t.translations("bg",TRANSLATIONS.bg),t.useSanitizeValueStrategy("escape");var e=JSON.parse(localStorage.getItem("settings")),n=_.isEmpty(e)?config.defaults.locale:e.locale;t.preferredLanguage(n.id)}]).filter("mapsUrl",["$sce",function(t){return function(e){return _.isEmpty(e)?t.trustAsResourceUrl(config.maps.js):t.trustAsResourceUrl(config.maps.js+"?key="+e)}}]),ctrl=angular.module("toxic.geotracker.controllers",[]);config={maps:{js:"https://maps.googleapis.com/maps/api/js",types:{js:"settings.map.type.js",native:"settings.map.type.native"}},defaults:{locale:{id:"en",name:"English"},mapType:"js",apikey:"AIzaSyAFqZ9Fs3e9PK0YpfOom-Ewi_gh4qV0eqc"}};var TRANSLATIONS={en:{name:"English","nav.menu":"Menu","nav.home":"Home","nav.history":"History","nav.settings":"Settings","nav.about":"About","nav.edit":"Edit","track.startTime":"Start","track.endTime":"End","track.duration":"Duration","track.start":"Start new track","track.stop":"Stop","track.save":"Save","track.title":"Track title","track.notes":"Track notes","track.point_no":"Point #{{ id }}","track.longitude":"Longitude","track.latitude":"Latitude","track.altitude":"Altitude","track.direction":"Heading","track.speed":"Speed, km/h","track.average_speed":"Avg. speed, km/h","track.displacement":"Displacement, meters","track.details":"Details","track.delete":"Delete","track.edit":"Edit","settings.language":"Language","settings.maptypes":"Map type","settings.map.type.js":"JavaScript","settings.map.type.native":"Native","settings.apikey":"Google API Key","dialog.confirm":"Confirm","dialog.track.confirm":"Are you sure you want to delete this track?","common.yes":"Yes","common.no":"No","common.cancel":"Cancel","time.year":"year(s)","time.month":"month(s)","time.day":"day(s)","time.hour":"hour(s)","time.minute":"minute(s)","time.second":"second(s)","about.googleMapsLegal":"Google Maps Legal Notice"},bg:{name:"Български","nav.menu":"Меню","nav.home":"Начало","nav.history":"История","nav.settings":"Настройки","nav.about":"Информация","nav.edit":"Редактирай","track.startTime":"Начало","track.endTime":"Край","track.duration":"Време","track.start":"Нов маршрут","track.stop":"Стоп","track.save":"Запази","track.title":"Име на маршрута","track.notes":"Бележки","track.point_no":"Точка №{{ id }}","track.longitude":"Геогр. дълж.","track.latitude":"Геогр. шир.","track.altitude":"Надморска височина","track.direction":"Посока","track.speed":"Скорост, км/ч","track.average_speed":"Средна скорост, км/ч","track.displacement":"Денивелация, метри","track.details":"Детайли","track.delete":"Изтрий","track.edit":"Редактирай","settings.language":"Език","settings.maptypes":"Тип карти","settings.map.type.js":"JavaScript","settings.map.type.native":"Native","settings.apikey":"Google API Key","dialog.confirm":"Потвърди","dialog.track.confirm":"Наистина ли искате да изтриете този запис?","common.yes":"Да","common.no":"Не","common.cancel":"Откажи","time.year":"г.","time.month":"мес.","time.day":"дн.","time.hour":"ч.","time.minute":"мин.","time.second":"сек.","about.googleMapsLegal":"Лиценз на Google Maps"}};ctrl.controller("AboutController",["$scope","$ionicModal","$ionicLoading","NativeMapsService",function(t,e,n,a){t.googleMapsLegal=function(){n.show(),a.getLicenseInfo().then(function(e){t.gmLicense=e,t.openModal(),n.hide()})},e.fromTemplateUrl("legal-modal.html",{scope:t,animation:"slide-in-up"}).then(function(e){t.modal=e}),t.openModal=function(){t.modal.show()},t.closeModal=function(){t.modal.hide()},t.$on("$destroy",function(){t.modal.remove()}),t.$on("modal.hidden",function(){}),t.$on("modal.removed",function(){})}]),ctrl.controller("AppCtrl",function(){}),ctrl.controller("MenuController",["$rootScope","$scope","$ionicSideMenuDelegate",function(t,e,n){e.$watch(function(){return n.isOpenLeft()},function(n){e.hideLeft=!n;var a=n?"sidemenu:on":"sidemenu:off";t.$emit(a)})}]),ctrl.controller("SettingsController",["$rootScope","$scope","mapTypes","availableLanguages","settings","SettingsService",function(t,e,n,a,o,i){e.mapTypes=n,e.availableLanguages=a,e.settings=o,e.$watch("settings.locale",function(e){t.$emit("locale-changed",e)}),e.$watch("settings",function(t){i.set(t)},!0)}]),geoApp.service("I18nService",["$translate",function(t){this.getAvailableLanguages=function(){var t=[];return angular.forEach(TRANSLATIONS,function(e,n){t.push({id:n,name:e.name})}),t},this.setPreferedLanguage=function(e){localStorage.setItem("locale",JSON.stringify(e)),t.use(e.id)}}]),geoApp.factory("JsMapsService",["$rootScope","$q","$timeout",function(t,e,n){var a={};return a.initMap=function(t,a){var o=e.defer(),i={zoom:a.zoom?a.zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP};return a&&a.point&&(a.point.lat&&a.point.lng?i.center={lat:a.point.lat,lng:a.point.lng}:a.point.latitude&&a.point.longitude&&(i.center={lat:a.point.latitude,lng:a.point.longitude})),n(function(){o.resolve(new google.maps.Map(document.getElementById(t),i))}),o.promise},a.setPosition=function(t,e){return new google.maps.LatLng(t,e)},a.getPolylinePoints=function(t){var e=[];return angular.forEach(t,function(t){this.push(a.setPosition(t.coords.latitude,t.coords.longitude))},e),e},a.addMarker=function(t,e,n){var o=new google.maps.Marker({position:a.setPosition(e,n)});return o.setMap(t),t.setCenter(o.getPosition()),t},a.remove=function(t,e){var n=document.getElementById(e);return n.innerHTML="",n.removeAttribute("style"),t=null},a.addPolyline=function(t,e){var n={path:google.maps.SymbolPath.CIRCLE,strokeOpacity:1,strokeWeight:2,scale:4,strokeColor:"#990000",fillColor:"#ffffff",fillOpacity:1};return new google.maps.Polyline({path:e,strokeOpacity:0,icons:[{icon:n,offset:"0",repeat:"20px"}],map:t}),t},a}]),geoApp.factory("NativeMapsService",["$rootScope","$q",function(t,e){var n={};return n.initMap=function(a,o){var i=e.defer(),r=document.getElementById(a);o&&o.point&&(o.point.lat&&o.point.lng?o.latLng=n.setPosition(o.point.lat,o.point.lng):o.point.latitude&&o.point.longitude&&(o.latLng=n.setPosition(o.point.latitude,o.point.longitude)),delete o.point),_.isUndefined(o.zoom)&&(o.zoom=10);var c=plugin.google.maps.Map.getMap(r,{camera:o});return t.$on("sidemenu:on",function(){c.setClickable(!1)}),t.$on("sidemenu:off",function(){c.setClickable(!0)}),c.addEventListener(plugin.google.maps.event.MAP_READY,function(t){i.resolve(t)}),i.promise},n.setPosition=function(t,e){return new plugin.google.maps.LatLng(t,e)},n.getPolylinePoints=function(t){var e=[];return angular.forEach(t,function(t){this.push(n.setPosition(t.coords.latitude,t.coords.longitude))},e),e},n.addMarker=function(t,e,a){var o=n.setPosition(e,a);return t.addMarker({position:o,icon:{url:"www/img/marker.png",size:{width:10,height:10}}}),t.setCenter(o),t},n.remove=function(t){return t.remove(),t=null},n.addPolyline=function(t,e){return t.addPolyline({points:e,color:"#990000",width:5}),t},n.getLicenseInfo=function(){var t=e.defer();return plugin.google.maps.Map.getLicenseInfo(function(e,n){t.resolve(e||n)}),t.promise},n}]),geoApp.service("SettingsService",["$translate","I18nService",function(t,e){this.get=function(){var t=JSON.parse(localStorage.getItem("settings"));return _.isEmpty(t)&&(t=this.setDefaults()),t},this.set=function(t){var t=_.omitBy(t,function(t){return _.isEmpty(t)});localStorage.setItem("settings",JSON.stringify(t))},this.setDefaults=function(){var t={locale:config.defaults.locale,mapType:_.filter(this.getMapTypes(),{id:config.defaults.mapType}).shift(),apikey:config.defaults.apikey};return this.set(t),t},this.getMapTypes=function(){var e=[];return angular.forEach(config.maps.types,function(e,n){this.push({id:n,name:t.instant(e)})},e),e}}]),geoApp.factory("TrackStorage",["$translate",function(t){var e="tracks",n={};n.getAll=function(){var t=o();return _.isNull(t)?[]:JSON.parse(t)},n.getById=function(t){return _.find(n.getAll(),{trackId:parseInt(t)})},n.save=function(t){var e=n.getAll(),o={trackId:t.trackId},i=!!_.find(e,o);if(_.isEmpty(e))e.push(t);else if(_.isEmpty(e)||i){if(!_.isEmpty(e)&&i){var r=_.findIndex(e,o);e[r]=t}}else e.push(t);a(e)},n.delete=function(t){var e=n.getAll();_.remove(e,function(e){return e.trackId===t.trackId}),a(e)},n.formatDuration=function(e){return moment.duration(e,"seconds").format("Y ["+t.instant("time.year")+"], M ["+t.instant("time.month")+"], D ["+t.instant("time.day")+"], h ["+t.instant("time.hour")+"], m ["+t.instant("time.minute")+"], s ["+t.instant("time.second")+"]")},n.formatPointTime=function(t){return moment.duration(t,"seconds").format("h:mm:ss")},n.getPolylinePoints=function(t){var e=[];return angular.forEach(t,function(t){this.push({lat:t.coords.latitude,lng:t.coords.longitude})},e),e},n.getChartData=function(t,e){var n={key:e,values:[]};return angular.forEach(t.points,function(t){_.isUndefined(t.timestamp)||_.isUndefined(t.coords[e])||this.push({x:t.timestamp,y:t.coords[e]})},n.values),n},n.getAverageSpeed=function(t){var e=[];return angular.forEach(t.points,function(t){!_.isUndefined(t.coords.speed)&&t.coords.speed>0&&this.push(parseFloat(t.coords.speed))},e),_.mean(e).toFixed(2)},n.getDisplacement=function(t){var e=[];return angular.forEach(t.points,function(t){_.isUndefined(t.coords.altitude)||this.push(parseFloat(t.coords.altitude))},e),(_.max(e)-_.min(e)).toFixed(2)};var a=function(t){localStorage.setItem(e,JSON.stringify(t))},o=function(){return localStorage.getItem(e)};return n}]),ctrl.controller("TrackEditController",["$scope","$state","$stateParams","TrackStorage",function(t,e,n,a){t.track=a.getById(n.trackId),t.updateTrack=function(){a.save(t.track),e.go("app.trackview",n)}}]),ctrl.controller("HistoryController",["$scope","TrackStorage",function(t,e){t.items=e.getAll()}]),ctrl.controller("TrackController",["$rootScope","$scope","$state","$ionicLoading","$cordovaGeolocation","JsMapsService","NativeMapsService","TrackStorage","requiredMapType",function(t,e,n,a,o,i,r,c,s){var l="map",u="js"===s?i:r;e.isTracking=!1,e.readyToSave=!1,e.initPoint={},t.mapScreenScale=.8,e.startTracking=function(){e.startTime=new Date,a.show(),o.getCurrentPosition({timeout:3e4,enableHighAccuracy:!0,maximumAge:1e4}).then(function(t){e.$broadcast("tracking:started",t)},e.positionError).finally(function(){a.hide()})},e.positionSuccess=function(t){e.points.push(t),e.trackWatch||e.watchTracking(),e.updateMap(t.coords.latitude,t.coords.longitude)},e.positionError=function(t){console.log("error",t)},e.watchTracking=function(){e.trackWatch=o.watchPosition({timeout:3e4,frequency:1e4,enableHighAccuracy:!0}),e.trackWatch.then(null,function(t){e.positionError(t),e.trackWatch.clearWatch(),e.watchTracking()},function(t){e.positionSuccess(t)})},e.updateMap=function(t,n){e.map=u.addMarker(e.map,t,n)},e.stopTracking=function(){e.endTime=new Date,e.isTracking=!1,e.trackWatch.clearWatch(),e.$broadcast("tracking:stopped")},e.saveHistory=function(){var t={trackId:e.trackId,points:e.points,info:_.omitBy(e.trackInfo,function(t){return _.isEmpty(t)}),startTime:e.startTime,endTime:e.endTime,duration:moment(e.endTime).diff(moment(e.startTime),"seconds")};c.save(t),e.$broadcast("tracking:saved")},e.$on("tracking:started",function(t,n){e.initPoint=n,u.initMap(l,{point:e.initPoint.coords,zoom:16}).then(function(t){e.map=t,e.isTracking=!0,e.points=[],e.trackWatch=null,e.trackId=(new Date).getTime(),e.trackInfo={title:null,notes:null},e.positionSuccess(e.initPoint),e.initPoint={}})}),e.$on("tracking:stopped",function(){e.readyToSave=!0}),e.$on("tracking:saved",function(t,a){e.map=u.remove(e.map,l),e.points=[],e.readyToSave=!1,n.go("app.history")})}]),ctrl.controller("TrackViewController",["$rootScope","$scope","$state","$ionicPopup","$translate","$timeout","JsMapsService","NativeMapsService","TrackStorage","track","requiredMapType",function(t,e,n,a,o,i,r,c,s,l,u){var p="map",d="js"===u?r:c;e.track=l,e.formattedDuration=s.formatDuration(e.track.duration);var g=s.getPolylinePoints(e.track.points),m=s.getChartData(e.track,"altitude"),f=s.getChartData(e.track,"speed");e.averageSpeed=s.getAverageSpeed(e.track),e.displacement=s.getDisplacement(e.track),t.mapScreenScale=1,i(function(){d.initMap(p,{point:g.length>3?g[Math.ceil(g.length/2)]:g[0],zoom:16}).then(function(t){e.map=t,e.map=d.addPolyline(e.map,g)})},1e3),e.altitudeChartOptions={title:{enable:!0,text:o.instant("track.altitude")},chart:{type:"lineChart",height:250,margin:{top:20,right:20,bottom:30,left:40},showControls:!1,showLegend:!1,useVoronoi:!1,clipEdge:!0,duration:100,useInteractiveGuideline:!0,interactiveLayer:{tooltip:{contentGenerator:function(t){var e="<ul>";return t.series.forEach(function(t){var n=o.instant("track."+t.key);e+="<li style='padding: 5px; color:"+t.color+"'>"+n+" : <b>"+t.value+"</b></li>"}),e+="</ul>"}}},xAxis:{showMaxMin:!1,tickFormat:function(t){return s.formatPointTime((t-e.track.trackId)/1e3)}},yAxis:{showMaxMin:!1,tickFormat:function(t){return t}}}},e.speedChartOptions=angular.copy(e.altitudeChartOptions),e.speedChartOptions.title.text=o.instant("track.speed"),e.altitudeChartData=[m],e.speedChartData=[f],e.confirmDelete=function(){var t=a.confirm({title:o.instant("dialog.confirm"),template:o.instant("dialog.track.confirm"),cancelText:o.instant("common.cancel"),cancelType:"button-positive",okText:o.instant("common.yes"),okType:"button-default"});t.then(function(t){t&&(s.delete(e.track),n.go("app.history"))})}}]);