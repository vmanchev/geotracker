var geoApp=angular.module("toxic.geotracker",["ionic","starter.controllers","ngCordova","pascalprecht.translate"]).run(["$ionicPlatform","$rootScope","$timeout","SettingsService",function(t,e,a,n){t.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),e.loadScript=function(t,e,a){if(void 0===e&&(e="text/javascript"),t){var n=document.querySelector("script[src*='"+t+"']");if(!n){var r=document.getElementsByTagName("head");if(r&&r.length){var o=r[0];o&&(n=document.createElement("script"),n.setAttribute("src",t),n.setAttribute("type",e),a&&n.setAttribute("charset",a),o.appendChild(n))}}return n}},e.$watch("apikey",function(t){e.loadScript("https://maps.googleapis.com/maps/api/js?key="+t)}),e.apikey=n.get().apikey;var t=window.matchMedia("(orientation: portrait)");t.matches,t.addListener(function(t){a(t.matches?function(){angular.element(document.getElementById("map")).css("height","initial"),google.maps.event.trigger(e.map,"resize")}:function(){angular.element(document.getElementById("map")).css("height",screen.height*e.mapScreenScale+"px"),google.maps.event.trigger(e.map,"resize")})})})}]).config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("app",{url:"/app",abstract:!0,templateUrl:"templates/menu.html",controller:"AppCtrl"}).state("app.track",{url:"/track",cache:!1,views:{menuContent:{templateUrl:"templates/track.html",controller:"TrackController"}}}).state("app.history",{url:"/history",cache:!1,views:{menuContent:{templateUrl:"templates/history.html",controller:"HistoryController"}}}).state("app.trackview",{url:"/track/:trackId",cache:!1,resolve:{track:["$stateParams","TrackStorage",function(t,e){return e.getById(t.trackId)}]},views:{menuContent:{templateUrl:"templates/track-view.html",controller:"TrackViewController"}}}).state("app.trackedit",{url:"/track/edit/:trackId",cache:!1,views:{menuContent:{templateUrl:"templates/track-edit.html",controller:"TrackEditController"}}}).state("app.settings",{url:"/settings",cache:!1,views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsController"}}}),e.otherwise("/app/track")}]).config(["$translateProvider",function(t){t.translations("en",TRANSLATIONS.en),t.translations("bg",TRANSLATIONS.bg),t.useSanitizeValueStrategy("escape");var e=JSON.parse(localStorage.getItem("locale")),a=_.isNull(e)?"bg":e.id;t.preferredLanguage(a)}]),ctrl=angular.module("starter.controllers",[]),TRANSLATIONS={en:{name:"English","nav.menu":"Menu","nav.home":"Home","nav.history":"History","nav.settings":"Settings","nav.edit":"Edit","track.start":"Start new track","track.stop":"Stop","track.save":"Save","track.title":"Track title","track.notes":"Track notes","track.point_no":"Point #{{ id }}","track.longitude":"Longitude","track.latitude":"Latitude","track.altitude":"Altitude","track.direction":"Heading","track.speed":"Speed","track.details":"Details","track.delete":"Delete","track.edit":"Edit","track.startTime":"Start","track.endTime":"End","track.duration":"Duration","settings.language":"Language","settings.apikey":"Google API Key","dialog.confirm":"Confirm","dialog.track.confirm":"Are you sure you want to delete this track?","common.yes":"Yes","common.no":"No","common.cancel":"Cancel","time.year":"year(s)","time.month":"month(s)","time.day":"day(s)","time.hour":"hour(s)","time.minute":"minute(s)","time.second":"second(s)"},bg:{name:"Български","nav.menu":"Меню","nav.home":"Начало","nav.history":"История","nav.settings":"Настройки","nav.edit":"Редактирай","track.startTime":"Начало","track.endTime":"Край","track.duration":"Време","track.start":"Нов маршрут","track.stop":"Стоп","track.save":"Запази","track.title":"Име на маршрута","track.notes":"Бележки","track.point_no":"Точка №{{ id }}","track.longitude":"Геогр. дълж.","track.latitude":"Геогр. шир.","track.altitude":"Надм. вис.","track.direction":"Посока","track.speed":"Скорост","track.details":"Детайли","track.delete":"Изтрий","track.edit":"Редактирай","settings.language":"Език","settings.apikey":"Google API Key","dialog.confirm":"Потвърди","dialog.track.confirm":"Наистина ли искате да изтриете този запис?","common.yes":"Да","common.no":"Не","common.cancel":"Откажи","time.year":"г.","time.month":"мес.","time.day":"дн.","time.hour":"ч.","time.minute":"мин.","time.second":"сек."}};ctrl.controller("AppCtrl",function(){}),ctrl.controller("SettingsController",["$rootScope","$scope","$translate","$timeout","I18nService","SettingsService",function(t,e,a,n,r,o){e.availableLanguages=r.getAvailableLanguages(),e.settings=o.get(),e.selectedLanguage=JSON.parse(localStorage.getItem("locale")),e.setPreferedLanguage=function(t){r.setPreferedLanguage(t)},e.saveSettings=function(){o.set(e.settings),e.settings=o.get(),t.apikey=e.settings.apikey}}]),geoApp.service("I18nService",["$translate",function(t){this.getAvailableLanguages=function(){var t=[];return angular.forEach(TRANSLATIONS,function(e,a){t.push({id:a,name:e.name})}),t},this.setPreferedLanguage=function(e){localStorage.setItem("locale",JSON.stringify(e)),t.use(e.id)}}]),geoApp.service("SettingsService",["$translate",function(t){var e={apikey:"AIzaSyD8JvJ-krHO-x3ZU6It0rf_wOM2hK3KY4k"};this.get=function(){return _.defaults(JSON.parse(localStorage.getItem("settings")),e)},this.set=function(t){var t=_.omitBy(t,function(t){return _.isEmpty(t)});t=_.defaults(t,e),localStorage.setItem("settings",JSON.stringify(t))}}]),geoApp.factory("TrackStorage",["$translate",function(t){var e="tracks",a={};a.getAll=function(){var t=r();return _.isNull(t)?[]:JSON.parse(t)},a.getById=function(t){return _.find(a.getAll(),{trackId:parseInt(t)})},a.save=function(t){var e=a.getAll(),r={trackId:t.trackId},o=!!_.find(e,r);if(_.isEmpty(e))e.push(t);else if(_.isEmpty(e)||o){if(!_.isEmpty(e)&&o){var i=_.findIndex(e,r);e[i]=t}}else e.push(t);n(e)},a.delete=function(t){var e=a.getAll();_.remove(e,function(e){return e.trackId===t.trackId}),n(e)},a.formatDuration=function(e){return moment.duration(e,"seconds").format("Y ["+t.instant("time.year")+"], M ["+t.instant("time.month")+"], D ["+t.instant("time.day")+"], h ["+t.instant("time.hour")+"], m ["+t.instant("time.minute")+"], s ["+t.instant("time.second")+"]")},a.getPolylinePoints=function(t){var e=[];return angular.forEach(t,function(t){this.push({lat:t.coords.latitude,lng:t.coords.longitude})},e),e};var n=function(t){localStorage.setItem(e,JSON.stringify(t))},r=function(){return localStorage.getItem(e)};return a}]),ctrl.controller("TrackEditController",["$scope","$state","$stateParams","TrackStorage",function(t,e,a,n){t.track=n.getById(a.trackId),t.updateTrack=function(){n.save(t.track),e.go("app.trackview",a)}}]),ctrl.controller("HistoryController",["$scope","TrackStorage",function(t,e){t.items=e.getAll()}]),ctrl.controller("TrackController",["$rootScope","$scope","$state","$ionicLoading","$cordovaGeolocation","$translate","$timeout","TrackStorage",function(t,e,a,n,r,o,i,c){e.isTracking=!1,e.readyToSave=!1,t.mapScreenScale=.8,e.startTracking=function(){e.startTime=new Date,n.show(),r.getCurrentPosition({timeout:1e4,enableHighAccuracy:!0,maximumAge:3e3}).then(function(t){e.$broadcast("tracking:started"),e.positionSuccess(t)},e.positionError).finally(function(){n.hide()})},e.positionSuccess=function(t){e.points.push(t),e.trackWatch||e.watchTracking(),e.updateMap(t.coords.latitude,t.coords.longitude)},e.positionError=function(t){console.log("error",t)},e.watchTracking=function(){e.trackWatch=r.watchPosition({timeout:3e3,enableHighAccuracy:!1}),e.trackWatch.then(null,e.positionError,e.positionSuccess)},e.initMap=function(){if(_.isUndefined(t.map)){var e={zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP};i(function(){t.map=new google.maps.Map(document.getElementById("map"),e)})}},e.updateMap=function(a,n){angular.isUndefined(t.map)&&e.initMap();var r=new google.maps.LatLng(a,n),o=new google.maps.Marker({position:r});i(function(){o.setMap(t.map),t.map.setCenter(o.getPosition())})},e.resetMap=function(){var e=document.getElementById("map");e.innerHTML="",e.removeAttribute("style"),t.map=null},e.stopTracking=function(){e.endTime=new Date,e.isTracking=!1,e.trackWatch.clearWatch(),e.$broadcast("tracking:stopped")},e.saveHistory=function(){var t={trackId:e.trackId,points:e.points,info:_.omitBy(e.trackInfo,function(t){return _.isEmpty(t)}),startTime:e.startTime,endTime:e.endTime,duration:moment(e.endTime).diff(moment(e.startTime),"seconds")};c.save(t),e.$broadcast("tracking:saved")},e.$on("tracking:started",function(t,a){e.initMap(),e.isTracking=!0,e.points=[],e.trackWatch=null,e.trackId=(new Date).getTime(),e.trackInfo={title:null,notes:null}}),e.$on("tracking:stopped",function(t,a){e.readyToSave=!0}),e.$on("tracking:saved",function(t,n){e.resetMap(),e.points=[],e.readyToSave=!1,a.go("app.history")})}]),ctrl.controller("TrackViewController",["$rootScope","$scope","$state","$stateParams","$ionicPopup","$translate","TrackStorage","track",function(t,e,a,n,r,o,i,c){function s(e,a){t.map=new google.maps.Map(document.getElementById("map"),{zoom:15,center:e[0],mapTypeId:a});var n={path:google.maps.SymbolPath.CIRCLE,strokeOpacity:1,strokeWeight:2,scale:4,strokeColor:"#990000",fillColor:"#ffffff",fillOpacity:1};new google.maps.Polyline({path:e,strokeOpacity:0,icons:[{icon:n,offset:"0",repeat:"20px"}],map:t.map})}e.track=c,e.formattedDuration=i.formatDuration(e.track.duration),e.points=i.getPolylinePoints(e.track.points),t.mapScreenScale=1,s(e.points,"terrain"),e.confirmDelete=function(){var t=r.confirm({title:o.instant("dialog.confirm"),template:o.instant("dialog.track.confirm"),cancelText:o.instant("common.cancel"),cancelType:"button-positive",okText:o.instant("common.yes"),okType:"button-default"});t.then(function(t){t&&(i.delete(e.track),a.go("app.history"))})}}]);