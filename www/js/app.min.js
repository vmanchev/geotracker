var geoApp=angular.module("toxic.geotracker",["ionic","starter.controllers","ngCordova","pascalprecht.translate"]).run(["$ionicPlatform","$rootScope","$timeout","SettingsService",function(t,e,n,a){t.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault(),e.apikey=a.get().apikey;var t=window.matchMedia("(orientation: portrait)");t.matches,t.addListener(function(t){n(t.matches?function(){angular.element(document.getElementById("map")).css("height","initial"),google.maps.event.trigger(e.map,"resize")}:function(){angular.element(document.getElementById("map")).css("height",screen.height*e.mapScreenScale+"px"),google.maps.event.trigger(e.map,"resize")})})})}]).config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("app",{url:"/app",abstract:!0,templateUrl:"templates/menu.html",controller:"AppCtrl"}).state("app.track",{url:"/track",cache:!1,views:{menuContent:{templateUrl:"templates/track.html",controller:"TrackController"}}}).state("app.history",{url:"/history",cache:!1,views:{menuContent:{templateUrl:"templates/history.html",controller:"HistoryController"}}}).state("app.trackview",{url:"/track/:trackId",cache:!1,resolve:{track:["$stateParams","TrackStorage",function(t,e){return e.getById(t.trackId)}]},views:{menuContent:{templateUrl:"templates/track-view.html",controller:"TrackViewController"}}}).state("app.trackedit",{url:"/track/edit/:trackId",cache:!1,views:{menuContent:{templateUrl:"templates/track-edit.html",controller:"TrackEditController"}}}).state("app.settings",{url:"/settings",cache:!1,views:{menuContent:{templateUrl:"templates/settings.html",controller:"SettingsController"}}}),e.otherwise("/app/track")}]).config(["$translateProvider",function(t){t.translations("en",TRANSLATIONS.en),t.translations("bg",TRANSLATIONS.bg),t.useSanitizeValueStrategy("escape");var e=JSON.parse(localStorage.getItem("locale")),n=_.isNull(e)?"bg":e.id;t.preferredLanguage(n)}]).filter("mapsUrl",["$sce",function(t){return function(e){return _.isUndefined(e)?t.trustAsResourceUrl(config.maps.js):t.trustAsResourceUrl(config.maps.js+"?key="+e)}}]),ctrl=angular.module("starter.controllers",[]);config={maps:{js:"https://maps.googleapis.com/maps/api/js",types:{js:"settings.map.type.js",native:"settings.map.type.native"}}};var TRANSLATIONS={en:{name:"English","nav.menu":"Menu","nav.home":"Home","nav.history":"History","nav.settings":"Settings","nav.edit":"Edit","track.start":"Start new track","track.stop":"Stop","track.save":"Save","track.title":"Track title","track.notes":"Track notes","track.point_no":"Point #{{ id }}","track.longitude":"Longitude","track.latitude":"Latitude","track.altitude":"Altitude","track.direction":"Heading","track.speed":"Speed","track.details":"Details","track.delete":"Delete","track.edit":"Edit","track.startTime":"Start","track.endTime":"End","track.duration":"Duration","settings.language":"Language","settings.maptypes":"Map type","settings.map.type.js":"JavaScript","settings.map.type.native":"Native","settings.apikey":"Google API Key","dialog.confirm":"Confirm","dialog.track.confirm":"Are you sure you want to delete this track?","common.yes":"Yes","common.no":"No","common.cancel":"Cancel","time.year":"year(s)","time.month":"month(s)","time.day":"day(s)","time.hour":"hour(s)","time.minute":"minute(s)","time.second":"second(s)"},bg:{name:"Български","nav.menu":"Меню","nav.home":"Начало","nav.history":"История","nav.settings":"Настройки","nav.edit":"Редактирай","track.startTime":"Начало","track.endTime":"Край","track.duration":"Време","track.start":"Нов маршрут","track.stop":"Стоп","track.save":"Запази","track.title":"Име на маршрута","track.notes":"Бележки","track.point_no":"Точка №{{ id }}","track.longitude":"Геогр. дълж.","track.latitude":"Геогр. шир.","track.altitude":"Надм. вис.","track.direction":"Посока","track.speed":"Скорост","track.details":"Детайли","track.delete":"Изтрий","track.edit":"Редактирай","settings.language":"Език","settings.maptypes":"Тип карти","settings.map.type.js":"JavaScript","settings.map.type.native":"Native","settings.apikey":"Google API Key","dialog.confirm":"Потвърди","dialog.track.confirm":"Наистина ли искате да изтриете този запис?","common.yes":"Да","common.no":"Не","common.cancel":"Откажи","time.year":"г.","time.month":"мес.","time.day":"дн.","time.hour":"ч.","time.minute":"мин.","time.second":"сек."}};ctrl.controller("AppCtrl",function(){}),ctrl.controller("SettingsController",["$rootScope","$scope","$translate","$timeout","I18nService","SettingsService",function(t,e,n,a,o,r){e.mapTypes=r.getMapTypes(),e.availableLanguages=o.getAvailableLanguages(),e.settings=r.get(),e.selectedLanguage=JSON.parse(localStorage.getItem("locale")),e.setPreferedLanguage=function(t){o.setPreferedLanguage(t)},e.saveSettings=function(){r.set(e.settings),e.settings=r.get()}}]),geoApp.service("I18nService",["$translate",function(t){this.getAvailableLanguages=function(){var t=[];return angular.forEach(TRANSLATIONS,function(e,n){t.push({id:n,name:e.name})}),t},this.setPreferedLanguage=function(e){localStorage.setItem("locale",JSON.stringify(e)),t.use(e.id)}}]),geoApp.factory("NativeMapsService",["$rootScope","$q",function(t,e){var n={};return n.initMap=function(a,o){var r=e.defer(),i=document.getElementById(a);_.isUndefined(o.point)||_.isUndefined(o.point.latitude)||_.isUndefined(o.point.longitude)||(o.latLng=n.setPosition(o.point.latitude,o.point.longitude),delete o.point),_.isUndefined(o.zoom)&&(o.zoom=10);var c=plugin.google.maps.Map.getMap(i,{camera:o});return t.$on("sidemenu:on",function(){c.setClickable(!1)}),t.$on("sidemenu:off",function(){c.setClickable(!0)}),c.addEventListener(plugin.google.maps.event.MAP_READY,function(t){r.resolve(t)}),r.promise},n.setPosition=function(t,e){return new plugin.google.maps.LatLng(t,e)},n.getPolylinePoints=function(t){var e=[];return angular.forEach(t,function(t){this.push(n.setPosition(t.coords.latitude,t.coords.longitude))},e),e},n}]),geoApp.service("SettingsService",["$translate",function(t){this.get=function(){return JSON.parse(localStorage.getItem("settings"))||{}},this.set=function(t){var t=_.omitBy(t,function(t){return _.isEmpty(t)});localStorage.setItem("settings",JSON.stringify(t))},this.getMapTypes=function(){var e=[];return angular.forEach(config.maps.types,function(e,n){console.log(t.instant(e)),this.push({id:n,name:t.instant(e)})},e),e}}]),geoApp.factory("TrackStorage",["$translate",function(t){var e="tracks",n={};n.getAll=function(){var t=o();return _.isNull(t)?[]:JSON.parse(t)},n.getById=function(t){return _.find(n.getAll(),{trackId:parseInt(t)})},n.save=function(t){var e=n.getAll(),o={trackId:t.trackId},r=!!_.find(e,o);if(_.isEmpty(e))e.push(t);else if(_.isEmpty(e)||r){if(!_.isEmpty(e)&&r){var i=_.findIndex(e,o);e[i]=t}}else e.push(t);a(e)},n.delete=function(t){var e=n.getAll();_.remove(e,function(e){return e.trackId===t.trackId}),a(e)},n.formatDuration=function(e){return moment.duration(e,"seconds").format("Y ["+t.instant("time.year")+"], M ["+t.instant("time.month")+"], D ["+t.instant("time.day")+"], h ["+t.instant("time.hour")+"], m ["+t.instant("time.minute")+"], s ["+t.instant("time.second")+"]")},n.getPolylinePoints=function(t){var e=[];return angular.forEach(t,function(t){this.push({lat:t.coords.latitude,lng:t.coords.longitude})},e),e};var a=function(t){localStorage.setItem(e,JSON.stringify(t))},o=function(){return localStorage.getItem(e)};return n}]),ctrl.controller("TrackEditController",["$scope","$state","$stateParams","TrackStorage",function(t,e,n,a){t.track=a.getById(n.trackId),t.updateTrack=function(){a.save(t.track),e.go("app.trackview",n)}}]),ctrl.controller("HistoryController",["$scope","TrackStorage",function(t,e){t.items=e.getAll()}]),ctrl.controller("TrackController",["$rootScope","$scope","$state","$ionicLoading","$cordovaGeolocation","$translate","$timeout","TrackStorage","SettingsService",function(t,e,n,a,o,r,i,c,s){e.isTracking=!1,e.readyToSave=!1,t.mapScreenScale=.8,e.startTracking=function(){e.startTime=new Date,a.show(),o.getCurrentPosition({timeout:1e4,enableHighAccuracy:!0,maximumAge:3e3}).then(function(t){e.$broadcast("tracking:started"),e.positionSuccess(t)},e.positionError).finally(function(){a.hide()})},e.positionSuccess=function(t){e.points.push(t),e.trackWatch||e.watchTracking(),e.updateMap(t.coords.latitude,t.coords.longitude)},e.positionError=function(t){console.log("error",t)},e.watchTracking=function(){e.trackWatch=o.watchPosition({timeout:3e4,frequency:1e4,enableHighAccuracy:!0}),e.trackWatch.then(null,function(t){e.positionError(t),e.trackWatch.clearWatch(),e.watchTracking()},e.positionSuccess)},e.initMap=function(){var e={zoom:15,mapTypeId:google.maps.MapTypeId.ROADMAP};i(function(){t.map=new google.maps.Map(document.getElementById("map"),e)})},e.updateMap=function(n,a){angular.isUndefined(t.map)&&e.initMap();var o=new google.maps.LatLng(n,a),r=new google.maps.Marker({position:o});i(function(){r.setMap(t.map),t.map.setCenter(r.getPosition())})},e.resetMap=function(){var e=document.getElementById("map");e.innerHTML="",e.removeAttribute("style"),t.map=null},e.stopTracking=function(){e.endTime=new Date,e.isTracking=!1,e.trackWatch.clearWatch(),e.$broadcast("tracking:stopped")},e.saveHistory=function(){var t={trackId:e.trackId,points:e.points,info:_.omitBy(e.trackInfo,function(t){return _.isEmpty(t)}),startTime:e.startTime,endTime:e.endTime,duration:moment(e.endTime).diff(moment(e.startTime),"seconds")};c.save(t),e.$broadcast("tracking:saved")},e.$on("tracking:started",function(t,n){e.initMap(),e.isTracking=!0,e.points=[],e.trackWatch=null,e.trackId=(new Date).getTime(),e.trackInfo={title:null,notes:null}}),e.$on("tracking:stopped",function(t,n){e.readyToSave=!0}),e.$on("tracking:saved",function(t,a){e.resetMap(),e.points=[],e.readyToSave=!1,n.go("app.history")})}]),ctrl.controller("TrackViewController",["$rootScope","$scope","$state","$stateParams","$ionicPopup","$translate","$timeout","TrackStorage","SettingsService","track",function(t,e,n,a,o,r,i,c,s,l){function p(e,n){t.map=new google.maps.Map(document.getElementById("map"),{zoom:15,center:e.length>3?e[Math.ceil(e.length/2)]:e[0],mapTypeId:n});var a={path:google.maps.SymbolPath.CIRCLE,strokeOpacity:1,strokeWeight:2,scale:4,strokeColor:"#990000",fillColor:"#ffffff",fillOpacity:1};new google.maps.Polyline({path:e,strokeOpacity:0,icons:[{icon:a,offset:"0",repeat:"20px"}],map:t.map})}e.track=l,e.formattedDuration=c.formatDuration(e.track.duration),e.points=c.getPolylinePoints(e.track.points),t.mapScreenScale=1,i(function(){p(e.points,"terrain")}),e.confirmDelete=function(){var t=o.confirm({title:r.instant("dialog.confirm"),template:r.instant("dialog.track.confirm"),cancelText:r.instant("common.cancel"),cancelType:"button-positive",okText:r.instant("common.yes"),okType:"button-default"});t.then(function(t){t&&(c.delete(e.track),n.go("app.history"))})}}]);